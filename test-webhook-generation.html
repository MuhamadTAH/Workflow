<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Automatic Webhook Generation</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .test-result { padding: 15px; margin: 10px 0; border-radius: 8px; }
        .success { background-color: #d1fae5; border: 2px solid #10b981; color: #065f46; }
        .error { background-color: #fee2e2; border: 2px solid #ef4444; color: #991b1b; }
        .webhook-url { font-family: monospace; font-size: 14px; background: #f3f4f6; padding: 10px; border-radius: 4px; word-break: break-all; }
        button { background: #2563eb; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; margin: 10px 5px; }
        button:hover { background: #1d4ed8; }
    </style>
</head>
<body>
    <h1>üîó Test Automatic Webhook Generation</h1>
    <p>This page tests the automatic workflow ID generation and webhook URL creation system.</p>

    <button onclick="testWorkflowGeneration()">üß™ Test Workflow ID Generation</button>
    <button onclick="testWebhookURL()">üîó Test Webhook URL</button>
    <button onclick="testFullFlow()">üöÄ Test Complete Flow</button>

    <div id="results"></div>

    <script>
        // Simulate the workflow ID generation logic from App.js
        function generateWorkflowId(workflowName = 'Test Workflow') {
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(2, 8);
            const cleanName = workflowName.toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')  // Remove special characters
                .replace(/\s+/g, '-')         // Replace spaces with hyphens
                .substring(0, 20);            // Limit length
            return `${cleanName || 'workflow'}-${random}`;
        }

        // Test workflow ID generation
        function testWorkflowGeneration() {
            const results = document.getElementById('results');
            
            try {
                const workflowId1 = generateWorkflowId('Customer Support Chat');
                const workflowId2 = generateWorkflowId('Sales Bot Workflow');
                const workflowId3 = generateWorkflowId('General Help & FAQ!');
                const workflowId4 = generateWorkflowId(''); // Empty name test
                
                results.innerHTML = `
                    <div class="test-result success">
                        <h3>‚úÖ Workflow ID Generation Test PASSED</h3>
                        <p><strong>Sample Generated IDs:</strong></p>
                        <ul>
                            <li><code>${workflowId1}</code> (from "Customer Support Chat")</li>
                            <li><code>${workflowId2}</code> (from "Sales Bot Workflow")</li>
                            <li><code>${workflowId3}</code> (from "General Help & FAQ!")</li>
                            <li><code>${workflowId4}</code> (from empty name)</li>
                        </ul>
                        <p>All IDs are unique, readable, and URL-safe! üéâ</p>
                    </div>
                `;
            } catch (error) {
                results.innerHTML = `
                    <div class="test-result error">
                        <h3>‚ùå Workflow ID Generation Test FAILED</h3>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Test webhook URL creation
        function testWebhookURL() {
            const results = document.getElementById('results');
            
            try {
                const workflowId = generateWorkflowId('My Website Chat');
                const webhookUrl = `https://workflow-lg9z.onrender.com/api/chat/webhook/${workflowId}`;
                
                results.innerHTML = `
                    <div class="test-result success">
                        <h3>‚úÖ Webhook URL Generation Test PASSED</h3>
                        <p><strong>Generated Workflow ID:</strong> <code>${workflowId}</code></p>
                        <p><strong>Complete Webhook URL:</strong></p>
                        <div class="webhook-url">${webhookUrl}</div>
                        <p>‚úÖ URL is properly formatted and ready to use!</p>
                        <button onclick="copyToClipboard('${webhookUrl}')">üìã Copy URL</button>
                        <button onclick="testWebhookEndpoint('${webhookUrl}')">üß™ Test Endpoint</button>
                    </div>
                `;
            } catch (error) {
                results.innerHTML = `
                    <div class="test-result error">
                        <h3>‚ùå Webhook URL Generation Test FAILED</h3>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Test the complete flow
        function testFullFlow() {
            const results = document.getElementById('results');
            
            try {
                // Simulate creating a workflow
                const workflowName = 'E-commerce Support Bot';
                const workflowId = generateWorkflowId(workflowName);
                const webhookUrl = `https://workflow-lg9z.onrender.com/api/chat/webhook/${workflowId}`;
                
                // Simulate chat trigger node data
                const chatTriggerData = {
                    type: 'chatTrigger',
                    label: 'Chat Trigger',
                    workflowId: workflowId,
                    filterKeywords: ['support', 'help', 'order'],
                    allowedDomains: ['mystore.com'],
                    requireUserInfo: false,
                    autoRespond: true,
                    autoResponseMessage: 'Hello! I received your message and will help you shortly.'
                };

                results.innerHTML = `
                    <div class="test-result success">
                        <h3>üöÄ Complete Flow Test PASSED</h3>
                        <p><strong>Workflow Name:</strong> ${workflowName}</p>
                        <p><strong>Generated ID:</strong> <code>${workflowId}</code></p>
                        <p><strong>Webhook URL:</strong></p>
                        <div class="webhook-url">${webhookUrl}</div>
                        
                        <h4>üìã Ready-to-Use Integration Code:</h4>
                        <pre style="background: #f8f9fa; padding: 15px; border-radius: 8px; overflow-x: auto;"><code>&lt;!-- Add this to your website --&gt;
&lt;script&gt;
  window.WorkflowChatConfig = {
    workflowId: '${workflowId}',
    apiUrl: 'https://workflow-lg9z.onrender.com',
    position: 'bottom-right',
    theme: 'light',
    title: 'Support Chat',
    welcomeMessage: 'Hello! How can I help you today?'
  };
&lt;/script&gt;
&lt;script src="https://workflow-lg9z.onrender.com/chat-widget.js"&gt;&lt;/script&gt;</code></pre>
                        
                        <p>üéâ <strong>Everything works perfectly!</strong> The system automatically:</p>
                        <ul>
                            <li>‚úÖ Generated a unique workflow ID</li>
                            <li>‚úÖ Created the complete webhook URL</li>
                            <li>‚úÖ Configured chat trigger settings</li>
                            <li>‚úÖ Provided ready-to-use integration code</li>
                        </ul>
                        
                        <button onclick="copyToClipboard('${webhookUrl}')">üìã Copy Webhook URL</button>
                        <button onclick="copyIntegrationCode('${workflowId}')">üìã Copy Integration Code</button>
                    </div>
                `;
            } catch (error) {
                results.innerHTML = `
                    <div class="test-result error">
                        <h3>‚ùå Complete Flow Test FAILED</h3>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Helper functions
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ Copied to clipboard!');
            });
        }

        function copyIntegrationCode(workflowId) {
            const code = `<!-- Add this to your website -->
<script>
  window.WorkflowChatConfig = {
    workflowId: '${workflowId}',
    apiUrl: 'https://workflow-lg9z.onrender.com',
    position: 'bottom-right',
    theme: 'light',
    title: 'Support Chat',
    welcomeMessage: 'Hello! How can I help you today?'
  };
</script>
<script src="https://workflow-lg9z.onrender.com/chat-widget.js"></script>`;
            
            navigator.clipboard.writeText(code).then(() => {
                alert('‚úÖ Integration code copied to clipboard!');
            });
        }

        // Test webhook endpoint
        async function testWebhookEndpoint(webhookUrl) {
            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: 'Test message from automatic webhook generation',
                        userName: 'Test User',
                        websiteUrl: 'https://example.com'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Webhook endpoint test successful! Your webhook URL is working.');
                } else {
                    alert('‚ö†Ô∏è Webhook responded but returned an error: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Webhook test failed: ' + error.message);
            }
        }

        // Auto-run basic test on load
        window.addEventListener('load', () => {
            testWorkflowGeneration();
        });
    </script>
</body>
</html>