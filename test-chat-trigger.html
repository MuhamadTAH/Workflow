<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Trigger Webhook Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        button {
            background: #28a745;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #218838;
        }
        button.secondary {
            background: #6c757d;
        }
        button.secondary:hover {
            background: #545b62;
        }
        .response {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .webhook-url {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            margin: 15px 0;
            font-family: monospace;
            word-break: break-all;
        }
        .example-payloads {
            margin-top: 30px;
        }
        .payload-example {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            cursor: pointer;
            border: 1px solid #dee2e6;
        }
        .payload-example:hover {
            background: #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Chat Trigger Webhook Tester</h1>
        
        <div class="form-group">
            <label for="nodeId">Node ID</label>
            <input type="text" id="nodeId" placeholder="e.g., node_123456" value="test-node-001">
        </div>
        
        <div class="form-group">
            <label for="webhookPath">Webhook Path</label>
            <input type="text" id="webhookPath" placeholder="e.g., chat" value="chat">
        </div>
        
        <div class="webhook-url">
            <strong>Generated Webhook URL:</strong><br>
            <span id="generatedUrl">https://workflow-lg9z.onrender.com/api/webhooks/chat/test-node-001/chat</span>
        </div>
        
        <div class="form-group">
            <label for="httpMethod">HTTP Method</label>
            <select id="httpMethod">
                <option value="POST">POST</option>
                <option value="GET">GET</option>
                <option value="PUT">PUT</option>
                <option value="PATCH">PATCH</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="secretToken">Secret Token (Optional)</label>
            <input type="password" id="secretToken" placeholder="Optional X-Secret header">
        </div>
        
        <div class="form-group">
            <label for="payload">Message Payload (JSON)</label>
            <textarea id="payload" placeholder='{"text": "Hello bot!", "userId": "user123"}'>{
  "text": "Hello from chat trigger!",
  "userId": "user-123",
  "sessionId": "session-456",
  "timestamp": "2025-08-09T12:00:00Z"
}</textarea>
        </div>
        
        <button onclick="sendWebhook()">üöÄ Send Webhook</button>
        <button onclick="registerWebhook()" class="secondary">üìù Register Webhook</button>
        <button onclick="getStatus()" class="secondary">üìä Get Status</button>
        
        <div class="example-payloads">
            <h3>üìã Example Payloads</h3>
            <div class="payload-example" onclick="usePayload('simple')">
                <strong>Simple Chat Message:</strong><br>
                {"text": "Hello!", "userId": "user123"}
            </div>
            <div class="payload-example" onclick="usePayload('telegram')">
                <strong>Telegram Format:</strong><br>
                {"message": {"text": "Hi there", "from": {"id": 12345, "first_name": "John"}}}
            </div>
            <div class="payload-example" onclick="usePayload('messenger')">
                <strong>Facebook Messenger:</strong><br>
                {"entry": [{"messaging": [{"message": {"text": "Hey bot"}, "sender": {"id": "67890"}}]}]}
            </div>
            <div class="payload-example" onclick="usePayload('whatsapp')">
                <strong>WhatsApp:</strong><br>
                {"messages": [{"text": {"body": "Hello WhatsApp"}, "from": "1234567890"}]}
            </div>
        </div>
        
        <div id="response"></div>
    </div>

    <script>
        // Update generated URL when inputs change
        function updateGeneratedUrl() {
            const nodeId = document.getElementById('nodeId').value;
            const path = document.getElementById('webhookPath').value;
            const url = `https://workflow-lg9z.onrender.com/api/webhooks/chat/${nodeId}/${path}`;
            document.getElementById('generatedUrl').textContent = url;
        }

        document.getElementById('nodeId').addEventListener('input', updateGeneratedUrl);
        document.getElementById('webhookPath').addEventListener('input', updateGeneratedUrl);

        // Example payload data
        const payloads = {
            simple: {
                "text": "Hello from simple chat!",
                "userId": "user-123",
                "timestamp": new Date().toISOString()
            },
            telegram: {
                "update_id": 12345,
                "message": {
                    "message_id": 1,
                    "from": {"id": 12345, "first_name": "John", "username": "john_doe"},
                    "chat": {"id": 12345, "type": "private"},
                    "text": "Hello Telegram bot!"
                }
            },
            messenger: {
                "entry": [{
                    "messaging": [{
                        "message": {"text": "Hey Facebook bot!"},
                        "sender": {"id": "67890"},
                        "timestamp": Date.now()
                    }]
                }]
            },
            whatsapp: {
                "messages": [{
                    "text": {"body": "Hello WhatsApp bot!"},
                    "from": "1234567890",
                    "id": "msg_001",
                    "timestamp": Date.now()
                }]
            }
        };

        function usePayload(type) {
            document.getElementById('payload').value = JSON.stringify(payloads[type], null, 2);
        }

        function showResponse(data, type = 'info') {
            const responseDiv = document.getElementById('response');
            responseDiv.className = `response ${type}`;
            responseDiv.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
        }

        async function sendWebhook() {
            const nodeId = document.getElementById('nodeId').value;
            const path = document.getElementById('webhookPath').value;
            const method = document.getElementById('httpMethod').value;
            const secretToken = document.getElementById('secretToken').value;
            const payload = document.getElementById('payload').value;

            if (!nodeId) {
                showResponse('Please enter a Node ID', 'error');
                return;
            }

            try {
                const url = `https://workflow-lg9z.onrender.com/api/webhooks/chat/${nodeId}/${path}`;
                
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (secretToken) {
                    headers['X-Secret'] = secretToken;
                }

                let body = null;
                if (method !== 'GET' && payload.trim()) {
                    try {
                        JSON.parse(payload); // Validate JSON
                        body = payload;
                    } catch (e) {
                        showResponse('Invalid JSON payload: ' + e.message, 'error');
                        return;
                    }
                }

                showResponse('Sending webhook request...', 'info');

                const response = await fetch(url, {
                    method: method,
                    headers: headers,
                    body: body
                });

                const result = await response.json();

                if (response.ok) {
                    showResponse(`‚úÖ Webhook sent successfully!\n\nResponse:\n${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    showResponse(`‚ùå Webhook failed!\n\nStatus: ${response.status}\nResponse:\n${JSON.stringify(result, null, 2)}`, 'error');
                }
            } catch (error) {
                showResponse(`‚ùå Error sending webhook:\n${error.message}`, 'error');
            }
        }

        async function registerWebhook() {
            const nodeId = document.getElementById('nodeId').value;
            const path = document.getElementById('webhookPath').value;
            const method = document.getElementById('httpMethod').value;
            const secretToken = document.getElementById('secretToken').value;

            if (!nodeId) {
                showResponse('Please enter a Node ID', 'error');
                return;
            }

            try {
                showResponse('Registering webhook...', 'info');

                const response = await fetch('https://workflow-lg9z.onrender.com/api/webhooks/register-chat-trigger', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nodeId: nodeId,
                        workflowId: 'test-workflow-001',
                        config: {
                            webhookPath: path,
                            httpMethod: method,
                            secretToken: secretToken || undefined
                        }
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showResponse(`‚úÖ Webhook registered successfully!\n\nResponse:\n${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    showResponse(`‚ùå Registration failed!\n\nStatus: ${response.status}\nResponse:\n${JSON.stringify(result, null, 2)}`, 'error');
                }
            } catch (error) {
                showResponse(`‚ùå Error registering webhook:\n${error.message}`, 'error');
            }
        }

        async function getStatus() {
            const nodeId = document.getElementById('nodeId').value;

            if (!nodeId) {
                showResponse('Please enter a Node ID', 'error');
                return;
            }

            try {
                showResponse('Getting webhook status...', 'info');

                const response = await fetch(`https://workflow-lg9z.onrender.com/api/webhooks/chat-trigger-status/${nodeId}`);
                const result = await response.json();

                if (response.ok) {
                    showResponse(`üìä Webhook Status:\n\n${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    showResponse(`‚ùå Status check failed!\n\nStatus: ${response.status}\nResponse:\n${JSON.stringify(result, null, 2)}`, 'error');
                }
            } catch (error) {
                showResponse(`‚ùå Error getting status:\n${error.message}`, 'error');
            }
        }

        // Initialize
        updateGeneratedUrl();
    </script>
</body>
</html>